{% extends "base.html" %}

{% block title %}Payment{% endblock %}

{% block content %}
    <h2>Order Summary</h2>
    <div class="order-summary">
        <p>Total Amount: £{{ grand_total|floatformat:2 }}</p>
        <p>Shipping Cost: £{{ shipping_cost|floatformat:2 }}</p>
        <p><strong>Grand Total: £{{ grand_total_with_shipping|floatformat:2 }}</strong></p>
    </div>

    <!-- Payment Form -->
    <div id="payment-form">
        <p>Enter your payment details below to complete the purchase.</p>
        <div id="card-element"><!-- Stripe card element will be inserted here --></div>
        <button id="submit-payment" class="btn btn-primary mt-3">Submit Payment</button>
    </div>

    <!-- Stripe Elements JavaScript -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const stripe = Stripe('{{ stripe_public_key }}');
            const elements = stripe.elements();
            const card = elements.create('card');
            card.mount('#card-element');

            const submitButton = document.getElementById('submit-payment');

            submitButton.addEventListener('click', function (e) {
                e.preventDefault();

                stripe.confirmCardPayment('{{ client_secret }}', {
                    payment_method: {
                        card: card,
                    }
                }).then(function (result) {
                    if (result.error) {
                        // Show error message to your customers
                        alert(result.error.message);  // Display the error
                      } else {
                        if (result.paymentIntent.status === 'succeeded') {
                          // Payment successful, redirect to the success page
                          window.location.href = "/checkout/order-success/";
                        }
                      }
                    });
            });
        });
    </script>
{% endblock %}
